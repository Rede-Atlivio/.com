rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNÇÕES AUXILIARES ---
    
    // Verifica se o usuário está logado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verifica se é o dono do documento
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Verifica se é Admin (SEGURANÇA CORRIGIDA: Apenas VOCÊ)
    function isAdmin() {
       return request.auth.token.email == "contatogilborges@gmail.com";
    }

    // Verifica se o usuário é PRO ou ADMIN
    function isProOrAdmin() {
      // Lê o documento do usuário para ver se is_pro é true ou se é admin
      let userDoc = get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data;
      return isAdmin() || (userDoc.keys().hasAll(['is_pro']) && userDoc.is_pro == true);
    }

    // --- REGRAS DAS COLEÇÕES ---

    // 1. USUÁRIOS
    match /usuarios/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isOwner(userId);
      // Protege saldo e status PRO contra edição manual do cliente
      allow update: if isAuthenticated() && isOwner(userId) 
                    && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['saldo', 'is_pro'])); 
    }

    // 2. ACTIVE PROVIDERS (Prestadores Online)
    match /active_providers/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner(userId);
    }

    // 3. OPORTUNIDADES (Lógica Feed PRO)
    match /oportunidades/{opId} {
      // Se for Admin/PRO: Vê tudo.
      // Se for Free: Só vê se created_at for menor que (agora - 5 minutos)
      allow read: if isAuthenticated() && (
        isProOrAdmin() || 
        resource.data.created_at < request.time - duration.value(5, 'm')
      );
      // Apenas Admin cria
      allow write: if isAuthenticated() && isAdmin();
    }

    // 4. MISSÕES
    match /missoes/{missaoId} {
      allow read: if isAuthenticated(); 
      allow write: if isAuthenticated() && isAdmin();
    }

    // 5. MISSION ASSIGNMENTS (Envio de Provas)
    match /mission_assignments/{assignId} {
      // Usuário só lê as suas. Admin lê todas.
      allow read: if isAuthenticated() && (resource.data.profile_id == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.profile_id == request.auth.uid;
      allow update: if isAuthenticated() && isAdmin(); // Só admin aprova/rejeita
    }

    // 6. PEDIDOS (SERVICES - ORDERS)
    match /orders/{orderId} {
      // Só lê quem é o cliente, o prestador ou admin
      allow read: if isAuthenticated() && (
        resource.data.client_id == request.auth.uid || 
        resource.data.provider_id == request.auth.uid ||
        isAdmin()
      );
      // Criação permitida pelo cliente
      allow create: if isAuthenticated() && request.resource.data.client_id == request.auth.uid;
      // Atualização permitida aos envolvidos
      allow update: if isAuthenticated() && (
        resource.data.client_id == request.auth.uid || 
        resource.data.provider_id == request.auth.uid
      );
    }

    // 7. CHATS
    match /chats/{chatId} {
      // Só lê/escreve se seu ID estiver no array 'participants' ou for Admin
      allow read: if isAuthenticated() && (request.auth.uid in resource.data.participants || isAdmin());
      allow write: if isAuthenticated() && (request.auth.uid in resource.data.participants || isAdmin());

      // SUBCOLEÇÃO DE MENSAGENS (Herdando permissão do pai)
      match /messages/{msgId} {
        allow read, write: if isAuthenticated() && (
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants || isAdmin()
        );
      }
    }
    
    // 8. REVIEWS
    match /reviews/{reviewId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.client_id == request.auth.uid;
    }
    
    // 9. PRODUTOS (LOJA)
    match /produtos/{prodId} {
    	allow read: if true;
      allow write: if isAdmin();
    }
  }
}
