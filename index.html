<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlivio - Marketplace H√≠brido</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#1e3a8a">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chat-bubble-me { background-color: #3b82f6; color: white; border-radius: 12px 12px 0 12px; margin-left: auto; }
        .chat-bubble-them { background-color: #f3f4f6; color: #1f2937; border-radius: 12px 12px 12px 0; margin-right: auto; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .rate-star { cursor: pointer; color: #e5e7eb; transition: color 0.2s; }
        .rate-star.active { color: #fbbf24; }
        .tag-select.selected { background-color: #dbeafe; border-color: #3b82f6; color: #1e3a8a; font-weight: bold; }
        .filter-pill { white-space: nowrap; transition: all 0.2s; }
        .filter-pill.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .subtab-btn { border-bottom: 2px solid transparent; color: #9ca3af; transition: all 0.3s; cursor: pointer; }
        .subtab-btn.active { border-color: #2563eb; color: #1e3a8a; font-weight: 900; }
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans selection:bg-blue-500 selection:text-white">

    <audio id="notification-sound" src="https://actions.google.com/sounds/v1/cartoon/magic_chime.ogg" preload="auto"></audio>
    <audio id="online-sound" src="https://www.soundjay.com/buttons/sounds/button-09.mp3" preload="auto"></audio>

    <input type="file" id="profile-upload" accept="image/*" class="hidden" onchange="uploadFotoPerfil(this)">
    <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden">

    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-gray-800 text-center border-b-4 border-blue-900">
            <h2 class="text-4xl font-black text-blue-900 italic uppercase mb-2 tracking-tighter">Atlivio</h2>
            <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-8">Marketplace H√≠brido</p>
            <button onclick="loginGoogle()" class="w-full mb-4 bg-white text-gray-700 border-2 border-gray-100 font-bold py-4 rounded-xl flex items-center justify-center hover:bg-gray-50 hover:border-blue-200 transition shadow-sm group">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 mr-3 group-hover:scale-110 transition">
                Entrar com Google
            </button>
        </div>
    </div>

    <div id="role-selection" class="hidden min-h-screen flex items-center justify-center bg-slate-900 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg text-gray-800 text-center">
            <h2 class="text-2xl font-black text-blue-900 uppercase mb-2 italic">Identidade</h2>
            <p class="text-gray-400 text-xs mb-6">Como voc√™ quer usar a plataforma?</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                <button onclick="definirPerfil('cliente')" class="p-6 border-2 border-gray-100 rounded-2xl hover:border-blue-600 hover:bg-blue-50 transition">
                    <div class="text-4xl mb-3">üíé</div>
                    <div class="font-black text-blue-900 uppercase italic">Cliente</div>
                    <div class="text-[10px] text-gray-500 mt-1">Quero contratar servi√ßos e comprar.</div>
                </button>
                <button onclick="definirPerfil('prestador')" class="p-6 border-2 border-gray-100 rounded-2xl hover:border-blue-600 hover:bg-blue-50 transition">
                    <div class="text-4xl mb-3">üõ†Ô∏è</div>
                    <div class="font-black text-blue-900 uppercase italic">Prestador</div>
                    <div class="text-[10px] text-gray-500 mt-1">Quero trabalhar e cumprir miss√µes.</div>
                </button>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden min-h-screen bg-gray-50 text-gray-800 flex flex-col">
        <header class="bg-white shadow-sm p-4 flex justify-between items-center z-30 sticky top-0">
            <div class="flex flex-col">
                <div class="flex flex-col md:flex-row md:items-baseline gap-1">
                    <h1 class="text-2xl font-black text-blue-900 italic uppercase tracking-tighter">Atlivio</h1>
                    <span class="text-[8px] md:text-[10px] text-gray-400 font-bold uppercase tracking-widest border-l-0 md:border-l md:pl-2 border-gray-300">
                        O Primeiro Marketplace H√≠brido do Mundo
                    </span>
                </div>
                <button onclick="alternarPerfil()" id="btn-trocar-perfil" class="text-[9px] font-bold text-gray-500 uppercase italic flex items-center gap-1 hover:text-blue-600 transition bg-gray-50 px-2 py-1 rounded mt-1 border border-gray-100 w-fit">
                    üîÑ Trocar Perfil
                </button>
            </div>
            
            <div class="flex items-center gap-2">
                <div id="status-toggle-container" class="hidden bg-gray-100 p-2 rounded-lg flex items-center border border-gray-200">
                    <span class="text-[8px] font-bold text-gray-500 uppercase mr-2">Trabalhar</span>
                    <div class="relative inline-block w-8 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="online-toggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 left-0 transition-all duration-300"/>
                        <label for="online-toggle" class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                </div>
                <button onclick="logout()" class="text-red-400 font-bold text-[10px] uppercase border border-red-100 px-3 py-1 rounded-lg hover:bg-red-50">Sair</button>
            </div>
        </header>

        <nav class="flex bg-white border-b border-gray-100 z-20 overflow-x-auto no-scrollbar shadow-sm">
            <button onclick="switchTab('servicos')" id="tab-servicos" class="flex-shrink-0 py-4 px-4 text-[10px] font-black border-b-2 border-transparent text-gray-400 uppercase italic">Servi√ßos üõ†Ô∏è</button>
            <button onclick="switchTab('missoes')" id="tab-missoes" class="flex-shrink-0 py-4 px-4 text-[10px] font-black border-b-2 border-transparent text-gray-400 uppercase italic">Micro Tarefas üì∑</button>
            <button onclick="switchTab('loja')" id="tab-loja" class="flex-shrink-0 py-4 px-4 text-[10px] font-black border-b-2 border-transparent text-gray-400 uppercase italic">Loja üõí</button>
            <button onclick="switchTab('chat')" id="tab-chat" class="flex-shrink-0 py-4 px-4 text-[10px] font-black border-b-2 border-transparent text-gray-400 uppercase italic">Chat üí¨</button>
            <button onclick="switchTab('ganhar')" id="tab-ganhar" class="flex-shrink-0 py-4 px-4 text-[10px] font-black border-b-2 border-transparent text-green-600 uppercase italic">Carteira üí∞</button>
        </nav>

        <main class="flex-1 overflow-y-auto p-4 max-w-2xl mx-auto w-full pb-24">
            <section id="sec-servicos" class="hidden space-y-4 animate-fadeIn">
                <div id="servicos-cliente" class="hidden">
                    <div class="flex border-b border-gray-200 mb-4 justify-between bg-white rounded-xl shadow-sm p-1">
                        <button onclick="switchServiceSubTab('contratar')" id="subtab-contratar-btn" class="subtab-btn active flex-1 py-2 text-[10px] uppercase text-center">Contratar üîç</button>
                        <button onclick="switchServiceSubTab('andamento')" id="subtab-andamento-btn" class="subtab-btn flex-1 py-2 text-[10px] uppercase text-center">Em Andamento ‚è≥</button>
                        <button onclick="switchServiceSubTab('historico')" id="subtab-historico-btn" class="subtab-btn flex-1 py-2 text-[10px] uppercase text-center">Hist√≥rico üìú</button>
                    </div>

                    <div id="view-contratar">
                        <div class="flex gap-2 overflow-x-auto no-scrollbar mb-4 py-2" id="category-filters"></div>
                        <div id="lista-prestadores-realtime" class="grid grid-cols-2 gap-3"></div>
                    </div>
                </div>

                <div id="servicos-prestador" class="hidden">
                    <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-blue-100 flex justify-between items-center">
                        <h3 class="font-black text-xs text-blue-900 uppercase">Seu Painel</h3>
                        <button onclick="abrirConfiguracaoServicos()" class="text-[10px] text-blue-600 font-bold border border-blue-100 px-3 py-1 rounded-lg">‚úé CONFIGURAR</button>
                    </div>
                    <div id="pview-radar" class="text-center py-10"></div>
                </div>
            </section>

            <section id="sec-ganhar" class="hidden space-y-4 animate-fadeIn">
                <div class="bg-gradient-to-br from-green-900 to-slate-800 p-6 rounded-2xl text-white shadow-lg relative">
                    <p class="text-[10px] uppercase tracking-widest opacity-70 mb-1">Saldo Total</p>
                    <h2 class="text-4xl font-black italic">R$ <span id="user-balance">0,00</span></h2>
                </div>
                <button onclick="window.rodarSeedSistema()" class="w-full mt-10 bg-orange-600 text-white py-2 rounded-lg font-black text-[10px] uppercase">
                    ‚ö° POPULAR SISTEMA (TESTE)
                </button>
            </section>
        </main>
    </div>

    <div id="provider-setup-modal" class="hidden fixed inset-0 bg-black/90 z-50 flex flex-col items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 relative">
            <button onclick="document.getElementById('provider-setup-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 text-xl font-bold">&times;</button>
            <h3 class="font-black text-xl text-blue-900 uppercase italic mb-4">Meus Servi√ßos</h3>
            <div class="mb-4"><label class="text-[10px] font-bold text-gray-500 uppercase">Nome Profissional</label><input type="text" id="setup-name" class="w-full border p-3 rounded-xl text-sm font-bold text-gray-900"></div>
            <div id="my-services-list" class="space-y-3 mb-6 max-h-40 overflow-y-auto"></div>
            <div class="bg-gray-50 p-4 rounded-xl border mb-4">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <select id="new-service-category" class="w-full border p-2 rounded-lg text-xs">
                        <option value="Barman">Barman</option><option value="Gar√ßom">Gar√ßom</option><option value="Seguran√ßa">Seguran√ßa</option><option value="Limpeza">Limpeza</option><option value="Eletricista">Eletricista</option>
                    </select>
                    <input type="number" id="new-service-price" placeholder="R$" class="w-full border p-2 rounded-lg text-xs">
                </div>
                <button onclick="addServiceLocal()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold text-xs uppercase">+ Adicionar</button>
            </div>
            <button onclick="saveServicesAndGoOnline()" class="w-full bg-green-600 text-white py-3 rounded-xl font-black uppercase shadow-lg">Salvar e Ficar Online üì°</button>
        </div>
    </div>

    <div id="request-modal" class="hidden fixed inset-0 bg-black/90 z-50 flex flex-col items-center justify-end md:justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-t-2xl md:rounded-2xl shadow-2xl flex flex-col">
            <input type="hidden" id="service-base-price">
            <div class="bg-blue-900 p-4 text-white flex justify-between items-start rounded-t-2xl">
                <div><h3 class="font-black text-lg uppercase italic">Fazer Proposta</h3><p class="text-xs opacity-75">C√°lculo de reserva autom√°tico.</p></div>
                <button onclick="document.getElementById('request-modal').classList.add('hidden')" class="text-white text-xl font-bold">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="selecionarDesconto(0.05)" class="border border-green-200 bg-green-50 text-green-700 py-2 rounded-lg font-bold text-xs">-5%</button>
                    <button onclick="selecionarDesconto(0.10)" class="border border-green-200 bg-green-50 text-green-700 py-2 rounded-lg font-bold text-xs">-10%</button>
                    <button onclick="selecionarDesconto(0.15)" class="border border-green-200 bg-green-50 text-green-700 py-2 rounded-lg font-bold text-xs">-15%</button>
                </div>
                <div class="bg-gray-50 p-3 rounded-xl border">
                    <div class="flex justify-between items-center mb-2">
                        <label class="flex items-center gap-2"><input type="radio" name="price-type" id="radio-custom" onchange="ativarInputPersonalizado()"><span class="text-xs font-bold">Outro Valor</span></label>
                    </div>
                    <div class="relative"><span class="absolute left-3 top-2.5 text-gray-500 font-bold text-sm">R$</span><input type="number" id="req-value" disabled class="w-full border p-2 pl-9 rounded-lg text-lg font-black bg-gray-100"></div>
                </div>
                <div id="financial-summary" class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 hidden">
                    <div class="flex justify-between text-xs mb-1"><span>Reserva (30%)</span><span class="font-bold" id="calc-security">R$ 0,00</span></div>
                    <div class="flex justify-between text-xs mb-3 border-b pb-2"><span>Taxa (10%)</span><span class="font-bold" id="calc-fee">R$ 0,00</span></div>
                    <div class="flex justify-between text-sm text-blue-900 font-black"><span>TOTAL A PAGAR</span><span id="calc-total-reserva">R$ 0,00</span></div>
                </div>
                <button id="btn-confirm-req" disabled class="w-full py-3 text-xs font-bold text-white bg-blue-600 rounded-xl opacity-50 cursor-not-allowed uppercase">Enviar Proposta üöÄ</button>
            </div>
        </div>
    </div>

    <script type="module" src="./js/app.js"></script>
    <script type="module" src="./js/auth.js"></script>
    <script type="module" src="./js/modules/services.js"></script>
    <script type="module" src="./js/modules/products.js"></script>
    <script type="module" src="./js/chat.js"></script>
    <script type="module" src="./js/wallet.js"></script>

    <script>
        // Gerenciamento Geral de Abas
        window.switchTab = (tabName) => {
            document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`sec-${tabName}`).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('border-blue-600', 'text-blue-900', 'active'));
            document.getElementById(`tab-${tabName}`).classList.add('border-blue-600', 'text-blue-900', 'active');
        };

        // L√≥gica de UI para Propostas e C√°lculos (Modelo B)
        window.selecionarDesconto = (percentual) => {
            const basePrice = parseFloat(document.getElementById('service-base-price').value || 0);
            const novoValor = basePrice * (1 - percentual);
            document.getElementById('req-value').value = novoValor.toFixed(2);
            document.getElementById('radio-custom').checked = false;
            document.getElementById('req-value').disabled = true;
            window.calcularReserva(novoValor);
        };

        window.ativarInputPersonalizado = () => {
            const input = document.getElementById('req-value');
            input.disabled = false; input.focus();
            input.classList.remove('bg-gray-100');
            input.classList.add('bg-white');
        };

        window.calcularReserva = (valorTotal) => {
            if (!valorTotal || valorTotal <= 0) return;
            const seguranca = valorTotal * 0.30;
            const taxa = valorTotal * 0.10;
            const totalPagar = seguranca + taxa;

            document.getElementById('calc-security').innerText = `R$ ${seguranca.toFixed(2)}`;
            document.getElementById('calc-fee').innerText = `R$ ${taxa.toFixed(2)}`;
            document.getElementById('calc-total-reserva').innerText = `R$ ${totalPagar.toFixed(2)}`;
            document.getElementById('financial-summary').classList.remove('hidden');
            
            const btn = document.getElementById('btn-confirm-req');
            btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed');
        };

        document.getElementById('req-value')?.addEventListener('input', (e) => {
            window.calcularReserva(parseFloat(e.target.value));
        });
    </script>
</body>
</html>
