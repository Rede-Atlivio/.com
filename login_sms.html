<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Login SMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="max-w-md w-full bg-gray-800 p-6 rounded-xl shadow-2xl text-center">
        <h1 class="text-xl font-bold text-green-400 mb-2">üì± TESTE DE LOGIN SMS</h1>
        <p class="text-gray-400 text-[10px] mb-6">Autentica√ß√£o Nativa (Anti-bloqueio Android)</p>

        <div id="step-phone" class="space-y-4">
            <label class="block text-left text-xs font-bold text-gray-500">SEU WHATSAPP / TELEFONE</label>
            <input type="tel" id="phone-number" placeholder="+55 75 99999-9999" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white text-lg focus:border-green-500 outline-none">
            <p class="text-[10px] text-gray-500 text-left">Digite com o c√≥digo do pa√≠s (+55) e DDD.</p>
            
            <button onclick="enviarSMS()" id="btn-send" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg transition">
                RECEBER C√ìDIGO
            </button>
        </div>

        <div id="step-code" class="hidden space-y-4">
            <div class="bg-blue-900/30 p-3 rounded border border-blue-500/30 mb-4">
                <p class="text-xs text-blue-200">SMS enviado! Verifique suas mensagens.</p>
            </div>
            
            <label class="block text-left text-xs font-bold text-gray-500">C√ìDIGO DE 6 D√çGITOS</label>
            <input type="number" id="sms-code" placeholder="123456" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white text-lg tracking-widest text-center focus:border-blue-500 outline-none">
            
            <button onclick="verificarCodigo()" id="btn-verify" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg transition">
                CONFIRMAR E ENTRAR
            </button>
            
            <button onclick="location.reload()" class="text-xs text-gray-500 underline mt-2">Tentar outro n√∫mero</button>
        </div>

        <div id="recaptcha-container" class="mt-4 flex justify-center"></div>

        <div id="status-log" class="mt-6 text-[10px] font-mono text-left bg-black p-2 rounded h-24 overflow-y-auto text-green-400 border border-gray-700">
            > Aguardando n√∫mero...
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCj89AhXZ-cWQXUjO7jnQtwazKXInMOypg", 
            authDomain: "atlivio-oficial-a1a29.firebaseapp.com", 
            projectId: "atlivio-oficial-a1a29", 
            storageBucket: "atlivio-oficial-a1a29.firebasestorage.app", 
            messagingSenderId: "887430049204", 
            appId: "1:887430049204:web:d205864a4b42d6799dd6e1" 
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        // Define idioma para PT-BR (para o SMS e Captcha virem em portugu√™s)
        auth.languageCode = 'pt-br';

        const log = (msg) => {
            const el = document.getElementById('status-log');
            el.innerHTML += `<br>> ${msg}`;
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }

        // 1. Configurar ReCaptcha Invis√≠vel
        window.setupRecaptcha = () => {
            if(!window.recaptchaVerifier) {
                log("Configurando ReCaptcha...");
                window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                    'size': 'invisible', // Ou 'normal' se quiser que apare√ßa o check
                    'callback': (response) => {
                        log("ReCaptcha Resolvido!");
                        // onSignInSubmit(); // Pode chamar o envio direto se quiser
                    },
                    'expired-callback': () => {
                        log("ReCaptcha expirou. Tente novamente.");
                    }
                });
            }
        };

        // 2. Enviar SMS
        window.enviarSMS = async () => {
            const phoneNumber = document.getElementById('phone-number').value;
            if(!phoneNumber || phoneNumber.length < 10) return alert("Digite um n√∫mero v√°lido com DDD.");

            const btn = document.getElementById('btn-send');
            btn.disabled = true;
            btn.innerText = "Enviando...";

            setupRecaptcha();
            const appVerifier = window.recaptchaVerifier;

            log(`Enviando SMS para ${phoneNumber}...`);

            try {
                const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
                
                // Sucesso!
                window.confirmationResult = confirmationResult;
                log("‚úÖ SMS Enviado com sucesso!");
                
                // Troca de Tela
                document.getElementById('step-phone').classList.add('hidden');
                document.getElementById('step-code').classList.remove('hidden');

            } catch (error) {
                log("‚ùå ERRO AO ENVIAR:");
                log(error.message);
                console.error(error);
                
                // Reseta captcha em caso de erro
                if(window.recaptchaVerifier) window.recaptchaVerifier.clear();
                window.recaptchaVerifier = null;
                
                btn.disabled = false;
                btn.innerText = "RECEBER C√ìDIGO";
                alert("Erro: " + error.message);
            }
        };

        // 3. Verificar C√≥digo
        window.verificarCodigo = async () => {
            const code = document.getElementById('sms-code').value;
            if(!code) return alert("Digite o c√≥digo.");

            const btn = document.getElementById('btn-verify');
            btn.disabled = true;
            btn.innerText = "Validando...";

            log("Validando c√≥digo...");

            try {
                const result = await window.confirmationResult.confirm(code);
                const user = result.user;
                log("üéâ LOGIN SUCESSO!");
                log("UID: " + user.uid);
                log("Phone: " + user.phoneNumber);
                alert(`BEM-VINDO!\nLogin realizado com sucesso.\nID: ${user.uid}`);
                
                btn.innerText = "‚úÖ LOGADO";
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-green-600');

            } catch (error) {
                log("‚ùå C√ìDIGO INV√ÅLIDO");
                btn.disabled = false;
                btn.innerText = "CONFIRMAR E ENTRAR";
                alert("C√≥digo errado ou expirado.");
            }
        };
        
        // Inicializa Captcha ao carregar
        setupRecaptcha();

    </script>
</body>
</html>
